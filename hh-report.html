<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-split-layout/vaadin-split-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../vaadin-icons/vaadin-icons.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../hh-icons/hh-icons.html">
<script src="../ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
<link rel="import" href="../ag-grid-polymer/ag-grid-polymer.html">
<script src="licenseKey.js"></script>

<dom-module id="hh-report">
    <template>
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-theme-balham-dark.css">
        <style>
            :host {
                display: block;
                /*background-color: #ccc;*/
                height: 100%;
                width: 100%;
            }

            .container {
                display: flex;
                flex-direction: column;
                /*height: calc(100% - 10px);*/
                /*width: calc(100% - 10px);*/
                height: 100%;
                width: 100%;
                /*padding: 5px;*/
            }

            .item {
                width: 100%;
            }

            textarea {
                height: calc(100% - 23px);
                width: calc(100% - 20px);
                background-color: rgba(0, 0, 0, 0.10); /* 투명 (opacity: 0) */
                color: #aaaaaa;
                padding: 10px;
                border: 0px;
                resize: none;
                outline: none !important;
                font-size: 15px;
                line-height: 1.5em;
            }

            textarea::placeholder {
                color: #3c3d47;
            }

            paper-icon-button {
                --paper-icon-button: {
                    color: #aaaaaa;
                };
                --paper-icon-button-hover: {
                    color: #0087cb;
                };
                --paper-icon-button-disabled: {
                    color: #4C5667;
                };
            }

            .icon-container {
                /*height: 100%;*/
                margin: 0px 0;
                padding: 0 0px;
                text-align: center;
                /*width: 19.3%;*/
                display: inline-block;
                cursor: default;
                vertical-align: top;
                box-sizing: border-box;
            }

            .icon-container span {
                font-family: sans-serif;
                display: block;
                color: #aaaaaa;
                transition: all 600ms;
            }

            .icon-container .label-top {
                font-size: 11px;
                margin: 1px;
            }

            .icon-container .label-bottom {
                font-size: 12px;
            }

            .label-reader {
                font-family: sans-serif;
                font-size: 14px;
                color: #aaaaaa;
                font-weight: bold;

            }

            .item-container {
                height: 100%;
            }

            .configModal {
                width: 620px;
                hegith: 570px;
            }

            .configModal paper-checkbox {
                --paper-checkbox-label: {
                    font-size: 14px;
                    color: #aaaaaa;

                };
                --paper-checkbox-label-checked: {
                    font-size: 14px;
                    color: #aaaaaa;
                    font-weight: bold;
                };
                --paper-checkbox-unchecked-color: #aaaaaa;
                --paper-checkbox-checked-color: #0087cb;
            }

            .addDoctorModal {
                width: 420px;
                hegith: 365px;
            }

            ag-grid-polymer {
                width: 100%;
                color: #aaaaaa !important;
                font-size: 12px !important;
                font-weight: normal !important;
                background-color: #2d333f !important;
                font-family: "NotoSansCJKLight" !important;
            }

            .ag-header {
                background-color: #2d333f !important;
                color: #cccccc !important;
                border-bottom: 3px solid #0087cb !important;
                font-weight: bold !important;
                font-size: 12px !important;
            }

            .ag-row {
                border-bottom: 1px solid #414a59 !important;
            }

            .ag-row-even {
                background-color: rgba(76, 86, 103, 0.2) !important;
            }

            .ag-row-odd {
                background-color: #2d333f !important;
            }

            .ag-cell-focus {
                border: 1px solid darkgrey !important;
            }

            .modalBottomContainer {
                display:flex;
                /*width: 595px;*/
                width: calc(100% - 25px);
                height: 75px;
                align-items: center;
                justify-content: flex-end;
            }

            .modalBottomContainer paper-button {
                height: 30px;
                color: #ffffff;
                background-color: #aaaaaa;
                font-size: 13px;
                margin: 0 5px 0 5px;
            }

            .modalBottomContainer paper-button:hover {
                background-color: #0087cb;
            }

            paper-input {
                --paper-input-container-input-color: #fff;
                --paper-input-container-focus-color: #0087cb;
                --paper-input-container-label: {
                    font-size: 14px;
                };
                width: 150px;
            }

            iron-icon, div[suffix] {
                color: hsl(0, 0%, 50%);
                margin-right: 12px;
                width: 14px;
                height: 14px;
            }

            .ag-row-selected {
                background-color: #596072 !important;
                color: #fff !important;
            }

            #scpUsersModal {
                width: 200px;
                border-radius: 5px;
                margin: 0;

                border: 2px solid;
                border-color: #0087cb;
                color: #0087cb;

                top: 264px;

            }

            paper-listbox {
                padding: 0px;
                margin: 0px;
            }

            paper-item {
                font-size: 14px;
                cursor: pointer;
            }

            paper-item:hover {
                font-weight: bold;
                background-color: #0087cb;
                color: #fff;
            }


        </style>
        <div class="container">
            <div class="item" style="height: 65px; display: flex; justify-content: space-evenly; align-items: center">
                <div class="icon-container" id="approveDiv">
                    <paper-icon-button id="approve" icon="vaadin:check-square-o" on-click="handleClick" disabled></paper-icon-button>
                    <!--<span class="label-top" id="approveTitle">Approve/Attest</span>-->
                    <span class="label-top" >{{approveText}}</span>
                </div>
                <div class="icon-container" id="addendumDiv" style="display: none">
                    <paper-icon-button id="addendum" icon="vaadin:check-square" on-click="handleClick"></paper-icon-button>
                    <span class="label-top">Addendum</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button id="save" icon="vaadin:download" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Save</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button id="preliminary" icon="vaadin:external-link" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Preliminary</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button id="dictate" icon="vaadin:microphone" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Dictate</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button id="edit" icon="vaadin:edit" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Edit</span>
                </div>
                <!--<div class="icon-container">
                    <paper-icon-button id="consultTo" icon="vaadin:comment-ellipsis-o" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Consult to</span>
                </div>-->
                <div class="icon-container">
                    <paper-icon-button id="except" icon="vaadin:ban" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Except</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button id="markCVR" icon="vaadin:warning" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Mark CVR</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button id="print" icon="vaadin:print" on-click="handleClick" disabled></paper-icon-button>
                    <span class="label-top">Print Report</span>
                </div>
                <div class="icon-container">
                    <paper-icon-button icon="vaadin:cog" on-tap="openDialog" disabled></paper-icon-button>
                </div>
            </div>
            <div style="height: calc(100% - 130px);">
                <vaadin-split-layout orientation="vertical" style="height: 100%;" theme="minimal">
                    <div style="height: 33%; min-height: 72px; overflow: hidden">
                        <div style="height: 30px; display:flex; align-items: center; padding-left: 10px;background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                            Findings
                        </div>
                        <div style="height: calc(100% - 32px);">
                            <textarea value="{{findings::input}}" placeholder="Please enter findings">
                            </textarea>

                        </div>
                    </div>
                    <vaadin-split-layout orientation="vertical" style="height: 67%; min-height: 140px" theme="minimal">
                        <div style="height: 50%; min-height: 72px; overflow: hidden">
                            <div style="height: 30px; display:flex; align-items: center; padding-left: 10px;background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                                Conclusion
                            </div>
                            <div style="height: calc(100% - 32px);">
                                <textarea value="{{conclusion::input}}" placeholder="Please enter conclusion">
                                </textarea>
                            </div>
                        </div>
                        <div style="height: 50%; min-height: 72px; overflow: hidden">
                            <div style="height: 30px; display:flex; align-items: center; padding-left: 10px;background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                                Recommendation
                            </div>
                            <div style="height: calc(100% - 32px);">
                                <textarea value="{{recommendation::input}}" placeholder="Please enter recommendation">
                                </textarea>
                            </div>

                        </div>
                    </vaadin-split-layout>
                </vaadin-split-layout>
            </div>
            <div class="item" style="height: 65px; display: flex;">
                <div class="item-container" style="width: calc(100% - 340px); display:flex; align-items: center; padding-left: 10px;">
                    <span class="label-reader">Radiologist<br>{{radiologist}}</span>
                </div>
                <div class="item-container" style="width: 340px; display: flex; justify-content: space-evenly;">
                    <div class="icon-container">
                        <paper-icon-button id="resetToUnread" icon="vaadin:refresh" on-click="handleClick" disabled></paper-icon-button>
                        <span class="label-bottom">Reset to unread</span>
                    </div>
                    <div class="icon-container">
                        <paper-icon-button id="pasteJustPrevious" icon="vaadin:paste" on-click="handleClick" disabled></paper-icon-button>
                        <span class="label-bottom">Paste just previous</span>
                    </div>
                    <div class="icon-container">
                        <paper-icon-button id="clear" icon="vaadin:trash" on-click="clear"></paper-icon-button>
                        <span class="label-bottom">Clear</span>
                    </div>
                    <div class="icon-container">
                        <paper-icon-button id="prev" icon="healthhub:display-prev" on-click="handleClick"></paper-icon-button>
                        <span class="label-bottom">Prev</span>
                    </div>
                    <div class="icon-container">
                        <paper-icon-button id="next" icon="healthhub:display-next" on-click="handleClick"></paper-icon-button>
                        <span class="label-bottom">Next</span>
                    </div>
                </div>

            </div>
        </div>

        <paper-dialog id="configModal" class="configModal" modal>
            <div style="background-color: #2d333f; display: flex; flex-direction: column; width: 100%; height: 100%; padding: 0px; margin:0px;">
                <div style="width: calc(100% - 20px);height: 30px; display:flex; align-items: center; padding-left: 10px; padding-right:10px; justify-content: space-between; background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                    <div>
                        Report Configuration
                    </div>
                    <paper-icon-button icon="vaadin:close-circle" style="padding: 0px; width: 14px; height: 14px;" on-tap="closeConfigModal"></paper-icon-button>
                </div>
                <div style="display:flex; flex-direction: column; width: 560px; height: 430px; padding: 30px 30px 5px 30px;">
                    <div style=" display: flex; flex-direction:column; justify-content:space-between; width: 100%; height: 150px;">
                        <paper-checkbox disabled noink>Insert clinical info</paper-checkbox>
                        <paper-checkbox disabled noink>Insert study info</paper-checkbox>
                        <paper-checkbox disabled noink>Auto save report</paper-checkbox>
                        <paper-checkbox disabled noink>on-click expand report window (Report window click when, report window expand)</paper-checkbox>
                        <paper-checkbox disabled noink>Select phrase and alt+F1 (Google search)</paper-checkbox>
                    </div>
                    <div style="width: 100%; height: 29px; margin-top: 30px; border-top: 1px solid #aaaaaa">
                    </div>
                    <div style="width: 100%; height: 260px">
                        <div style="width: 100%; height: 30px; color: #cccccc; font-size: 14px;">
                            Radiologist setting
                            <paper-icon-button on-tap="openRadiologistDialog" icon="vaadin:plus-circle" style="padding: 0; height: 14px; width: 22px;"></paper-icon-button>
                        </div>
                        <ag-grid-polymer class="ag-theme-balham-dark"
                                         gridOptions="{{tGridOptions}}"
                                         rowData="{{tRowData}}"
                                         columnDefs="{{tColumnDefs}}" style="height: 230px;">
                        </ag-grid-polymer>
                    </div>
                </div>
                <div class="modalBottomContainer">
                    <paper-button id="saveRadiologist" on-tap="handleClick" raised>Save</paper-button>
                    <paper-button on-tap="closeConfigModal" raised>Close</paper-button>
                    <paper-button on-tap="resetRadiologists" raised>Reset to default</paper-button>
                </div>

            </div>
        </paper-dialog>

        <paper-dialog id="addDoctorModal" class="addDoctorModal">
            <div style="background-color: #2d333f; display: flex; flex-direction: column; width: 100%; height: 100%; padding: 0px; margin:0px;">
                <div style="width: calc(100% - 20px);height: 30px; display:flex; align-items: center; padding-left: 10px; padding-right:10px; justify-content: space-between; background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                    <div>
                        Add reporting doctor
                    </div>
                    <paper-icon-button icon="vaadin:close-circle" style="padding: 0px; width: 14px; height: 14px;" on-tap="closeAddDoctorModal"></paper-icon-button>
                </div>
                <div style="display:flex; flex-direction: column; width: 360px; height: 255px; padding: 0px 30px 5px 30px;">
                    <div style="width: 100%; height: 80px; display: flex; align-items: center">
                        <paper-input id="filterInput" label="Search" on-input="onFilterTextBoxChanged">
                            <iron-icon icon="vaadin:search" slot="prefix"></iron-icon>
                        </paper-input>
                    </div>
                    <!--<div style="background-color: blue; width: 100%; height: 180px;"></div>-->
                    <div style="width: 100%; height: 170px">
                        <ag-grid-polymer class="ag-theme-balham-dark"
                                         gridOptions="{{sGridOptions}}"
                                         rowData="{{sRowData}}"
                                         columnDefs="{{sColumnDefs}}" style="height: 180px;">
                        </ag-grid-polymer>
                    </div>
                </div>
                <div class="modalBottomContainer">
                    <paper-button on-tap="addDoctor" raised>Ok</paper-button>
                    <paper-button on-tap="closeAddDoctorModal" raised >Close</paper-button>
                </div>
            </div>
        </paper-dialog>

        <paper-dialog id="scpUsersModal" no-overlap horizontal-align="left" vertical-align="bottom"
                      exit-animation="fade-out-animation">
            <h3>Consult to</h3>
            <paper-listbox>
                <template is="dom-repeat" items="[[scpUsers]]">
                    <paper-item id="{{item.id}}" on-click="consultToBtnClickEvent">{{item.name}}</paper-item>
                </template>
            </paper-listbox>
        </paper-dialog>

    </template>

    <script>
        /**
         * `hh-report`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class HhReport extends Polymer.Element {
            static get is() {
                return 'hh-report';
            }

            ready() {
                super.ready();
            }

            static get properties() {
                return {
                    prop1: {
                        type: String,
                        value: 'hh-report'
                    },
                    radiologist: {
                        type: String,
                        value: ''
                    },
                    findings: {
                        type: String,
                        value: ""
                    },
                    conclusion: {
                        type: String,
                        value: ""
                    },
                    recommendation: {
                        type: String,
                        value: ""
                    },
                    approveText: {
                        type: String,
                        value: "Approve/Attest"
                    },
                    imageReport: {
                        type: Object
                    }
                };
            }

            constructor() {
                super();

                this.tGridOptions = {
                    defaultColDef: {
                        suppressMenu: true // 메뉴 막기
                    },
                    enableColResize: true,
                    toolPanelSuppressSideButtons: true,
                    suppressMenu: true,
                    suppressContextMenu: true
                };

                this.tColumnDefs = [
                    {headerName: "Role", field: "role", width: 70},
                    {headerName: "LicenseNo", field: "licenseNo", width: 110},
                    {headerName: "Name", field: "name", width: 80},
                    {headerName: "EngName", field: "engName", width: 100},
                    {headerName: "Department", field: "department", width: 120},
                    {headerName: "Position", field: "position", width: 117}
                ];

                this.tRowData = [];


                this.sGridOptions = {
                    defaultColDef: {
                        suppressMenu: true // 메뉴 막기
                    },
                    rowSelection: 'single',
                    enableColResize: true,
                    toolPanelSuppressSideButtons: true,
                    suppressMenu: true,
                    suppressContextMenu: true
                };

                this.sColumnDefs = [
                    {headerName: "LicenseNo", field: "licenseNo", width: 110},
                    {headerName: "Name", field: "name", width: 80},
                    {headerName: "EngName", field: "engName", width: 100},
                    {headerName: "Department", field: "department", width: 120},
                    {headerName: "Position", field: "position", width: 110}
                ];
                this.sRowData = [
                    // {id: "1234", department: "Neuroradiology", licenseNo: "5678", name: "나동규", position: "resident"},
                    // {id: "2342", department: "Neuroradiology", licenseNo: "5677", name: "김성현", position: "resident"},
                    // {id: "3253", department: "Neuroradiology", licenseNo: "5674", name: "이재희", position: "resident"},
                    // {id: "4231", department: "Neuroradiology", licenseNo: "5671", name: "정주혁", position: "resident"},
                    // {id: "2342", department: "Neuroradiology", licenseNo: "5278", name: "장보현", position: "resident"},
                    // {id: "2341", department: "Neuroradiology", licenseNo: "4231", name: "김민정", position: "resident"},
                    // {id: "3423", department: "Neuroradiology", licenseNo: "1234", name: "이성현", position: "resident"}
                ];

                this.sGridOptions.onRowDoubleClicked = (e) => {
                    this.selectedRow(e.data);
                };
            }

            handleClick(e) {
                let id = e.target.id;
                this.dispatchEvent(new CustomEvent('btnClickEvent', {detail: id}));
            }

            consultToBtnClickEvent(e) {
                let param = new Object();
                param.userId = e.target.id;
                param.username = e.target.innerText;
                this.dispatchEvent(new CustomEvent('consultToBtnClickEvent', {detail: param}));
            }

            clear() {
                this.initTextArea();
            }

            openDialog() {
                this.$.configModal.open();
            }

            openRadiologistDialog() {
                this.$.addDoctorModal.open();
            }

            closeConfigModal() {
                this.$.configModal.close();
            }

            closeAddDoctorModal() {
                this.$.addDoctorModal.close();
            }

            initTextArea() {
                this.findings = "";
                this.conclusion = "";
                this.recommendation = "";
            }

            getOpinion() {
                let opinion = new Object();
                opinion.finding = this.findings;
                opinion.conclusion = this.conclusion;
                opinion.recommendation = this.recommendation;
                opinion.imageReport = this.imageReport;
                return opinion;
            }

            setRadiologists(rows) {
                this.tRowData = rows;
            }

            setDoctors(rows) {
                this.sRowData = rows;
            }

            onFilterTextBoxChanged() {
                this.sGridOptions.api.setQuickFilter(this.$.filterInput.value);
            }

            addDoctor() {
                let row = this.sGridOptions.api.getSelectedRows()[0];
                this.selectedRow(row);
            }

            selectedRow(selectedRow) {
                if(selectedRow) {
                    let radiologistList = new Array();
                    radiologistList.push(selectedRow);
                    this.tRowData = radiologistList;
                    this.$.addDoctorModal.close();
                }
            }

            getRadiologists() {
                let radiologistLists = new Array();
                this.tGridOptions.api.forEachNode((rowNode) => {;
                    radiologistLists.push(rowNode.data)
                });
                return radiologistLists;
            }

            resetRadiologists() {
                this.tRowData = [];
            }

            enabledApproveBtn() {
                this.$.approve.disabled = false;
            }

            disabledApproveBtn() {
                this.$.approve.disabled = true;
            }

            invisibleApproveDiv() {
                this.$.approveDiv.style.display = "none";
            }

            visibleApproveDiv() {
                this.$.approveDiv.style.display = "block";
            }

            invisibleAddendumDiv() {
                this.$.addendumDiv.style.display = "none";
            }

            visibleAddendumDiv() {
                this.$.addendumDiv.style.display = "block";
            }

            changeApproveText(text) {
                this.approveText = text;
            }

            enabledSaveBtn() {
                this.$.save.disabled = false;
            }

            disabledSaveBtn() {
                this.$.save.disabled = true;
            }

            setScpUsers(users) {
                this.scpUsers = users;
            }

            openScpUsersModal() {
                this.$.scpUsersModal.positionTarget = this.$.approve;
                this.$.scpUsersModal.open();
            }

            closeScpUsersModal() {
                this.$.scpUsersModal.close();
            }

            enabledPrintBtn(){
                this.$.print.disabled = false;
            }

            disabledPrintBtn(){
                this.$.print.disabled = true;
            }

            /**
             * function setStructImage
             * image Report 구조체 저장
             *
             * Create by mjkim on 2019-07-17 오전 9:53
             **/
            setStructImage(imageReport) {
                if(imageReport) this.imageReport = JSON.parse(imageReport);
            }

        }

        window.customElements.define(HhReport.is, HhReport);
    </script>
</dom-module>
